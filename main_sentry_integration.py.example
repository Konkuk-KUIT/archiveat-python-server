from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import sentry_sdk
from sentry_sdk.integrations.fastapi import FastApiIntegration
import os

from models import (
    SummarizeYoutubeRequest,
    SummarizeGenericRequest,
    SummarizeNaverNewsRequest,
    SummarizeTistoryRequest,
    PythonSummaryResponse,
    HealthResponse,
    VideoInfo,
    ArticleInfo,
    Analysis,
    NewsletterSummaryBlock
)
from services.youtube import YouTubeProcessor
from services.summarizer import GeminiSummarizer
from services.naver_news import NaverNewsProcessor
from services.tistory import TistoryProcessor
import logging

# 로깅 설정
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Sentry 초기화
sentry_dsn = os.getenv("SENTRY_DSN")
if sentry_dsn:
    sentry_sdk.init(
        dsn=sentry_dsn,
        environment=os.getenv("SENTRY_ENVIRONMENT", "development"),
        traces_sample_rate=1.0,
        integrations=[FastApiIntegration()],
    )
    logger.info("Sentry initialized successfully")
else:
    logger.warning("SENTRY_DSN not set, Sentry not initialized")

app = FastAPI(
    title="Archiveat Python Server",
    description="LLM-powered content summarization service using Gemini AI",
    version="1.0.0"
)

# CORS 설정
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Health check endpoint
@app.get("/health", response_model=HealthResponse)
async def health_check():
    """Health check endpoint for monitoring"""
    return HealthResponse(
        status="healthy",
        message="Python server is running"
    )

# Sentry 테스트 엔드포인트 (개발용)
@app.get("/sentry-test")
async def sentry_test():
    """Sentry error tracking test endpoint"""
    logger.error("Testing Sentry error capture")
    raise HTTPException(status_code=500, detail="This is a test error for Sentry")

# 나머지 엔드포인트는 기존 코드와 동일...
